<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log√≠stica Pro - Vis√£o Financeira Completa</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-body: #f8fafc; --bg-sidebar: #ffffff; --text-main: #1e293b;
            --text-sub: #64748b; --border-color: #e2e8f0; --item-bg: #ffffff;
            --input-bg: #ffffff; --accent: #2563eb;
        }
        .dark-mode {
            --bg-body: #0f172a; --bg-sidebar: #1e293b; --text-main: #f1f5f9;
            --text-sub: #94a3b8; --border-color: #334155; --item-bg: #334155;
            --input-bg: #1e293b; --accent: #3b82f6;
        }
        * { box-sizing: border-box; transition: background 0.2s, color 0.2s; }
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; }
        
        .wrapper { display: flex; height: 100vh; width: 100vw; position: relative; }
        
        .top-nav {
            position: absolute; top: 0; left: 0; height: 50px; background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border-color); z-index: 100; 
            display: flex; align-items: center; padding: 0 20px; gap: 25px; 
            width: 100%; transition: width 0.3s ease;
        }
        .top-nav a { text-decoration: none; color: var(--text-main); font-weight: 600; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .top-nav a:hover { color: var(--accent); }

        .sidebar { 
            width: 25%; min-width: 320px; 
            height: 100%; background: var(--bg-sidebar); 
            padding: 70px 20px 20px 20px; overflow-y: auto; z-index: 10; 
            border-right: 1px solid var(--border-color); 
        }

        #painel-custos-extra {
            display: none; 
            width: 25%; min-width: 320px;
            height: 100%; background: var(--bg-body);
            padding: 70px 20px 20px 20px; overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }

        #painel-frota {
            position: absolute; right: -50%; top: 0; width: 50%; height: 100%; 
            background: var(--bg-sidebar); z-index: 200; border-left: 1px solid var(--border-color);
            padding: 40px; transition: right 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        }
        #painel-frota.active { right: 0; }

        .map-container { flex-grow: 1; height: 100%; position: relative; }
        #map { width: 100%; height: 100%; }

        .header-sidebar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        h2 { font-size: 1.1em; margin: 0; }
        #lista-pontos { list-style: none; padding: 0; margin: 0; }
        .ponto-item { background: var(--item-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 10px; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
        .handle { color: var(--text-sub); cursor: grab; font-size: 16px; user-select: none; }
        .deslocamento-config { padding: 10px; background: var(--bg-body); border-radius: 6px; margin-bottom: 10px; display: none; flex-direction: column; gap: 5px; border: 1px solid var(--border-color); }
        input, select { width: 100%; padding: 7px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px; background: var(--input-bg); color: var(--text-main); outline: none; }
        .grid-configs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .container-barra { height: 8px; background: var(--border-color); border-radius: 10px; overflow: hidden; display: flex; width: 100%; }
        .barra-vazio { background: #fb923c; height: 100%; transition: width 0.5s; }
        .barra-rota { background: #60a5fa; height: 100%; transition: width 0.5s; flex-grow: 1; }
        .financeiro { background: var(--bg-sidebar); padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px solid var(--border-color); }
        .financeiro .row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; color: var(--text-sub); }
        .frete-destaque { font-size: 1.3em; font-weight: 700; color: var(--text-main); border-top: 1px solid var(--border-color); padding-top: 10px; margin-top: 10px; }
        .calc-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        .btn-remove { background: #fee2e2; color: #ef4444; border: none; border-radius: 4px; cursor: pointer; padding: 2px 6px; }
        .btn-gestao { width: 100%; padding: 10px; background: none; border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 8px; }
        .secao-custo { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--border-color); }
        .label-custo { font-size: 10px; font-weight: 700; color: var(--text-sub); display: block; margin-bottom: 4px; text-transform: uppercase; }
        
        .lista-frota-content { flex-grow: 1; overflow-y: auto; margin-top: 20px; }
        .veiculo-card { background: var(--bg-body); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .f-checkbox { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-top: 5px; }
        .f-checkbox input { width: auto; }

        .sub-label { font-size: 9px; color: var(--text-sub); margin-bottom: 2px; display: block; }

        /* Estilos dos Alertas */
        .alerta-erro { background: #fee2e2; color: #b91c1c; padding: 10px; border-radius: 6px; font-size: 11px; font-weight: 600; margin-bottom: 10px; border: 1px solid #fecaca; display: none; }

        /* LAYOUT DE IMPRESS√ÉO */
        @media print {
            .top-nav, .theme-toggle, .btn-add, .calc-btn, .btn-gestao, .btn-remove, .handle, .map-container {
                display: none !important;
            }
            body, html { overflow: visible; height: auto; background: white !important; color: black !important; }
            .wrapper { display: block; }
            .sidebar, #painel-custos-extra { 
                width: 100%; min-width: 100%; position: static; display: block !important; 
                padding: 10px; border: none; height: auto; 
            }
            .financeiro { border: 2px solid #eee; page-break-inside: avoid; }
            input, select { border: none !important; appearance: none; font-weight: bold; }
            .header-sidebar h2 { font-size: 1.5em; border-bottom: 2px solid #000; padding-bottom: 5px; width: 100%; }
        }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="top-nav" id="topNav">
        <a onclick="toggleFrota()">üöõ Minha Frota</a>
        <a onclick="document.getElementById('themeBtn').click()">üåô Modo</a>
        <a onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</a>
    </div>

    <div id="painel-frota">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <h2 id="frota-titulo">Minha Frota</h2>
            <span style="cursor:pointer; font-size:24px;" onclick="toggleFrota()">&times;</span>
        </div>
        <div style="margin-top:20px;">
            <input type="hidden" id="f-edit-index" value="-1">
            <label class="label-custo">Apelido Frota / Modelo Veiculo</label>
            <input type="text" id="f-nome" placeholder="Ex: Scania R450 - Placa ABC-1234">
            
            <div class="grid-configs">
                <div>
                    <label class="label-custo">N√∫mero de Eixos</label>
                    <select id="f-eixos">
                        <option value="2">2 Eixos (Toco/VUC)</option>
                        <option value="3">3 Eixos (Truck/Pesado)</option>
                        <option value="4">4 Eixos (Articulados)</option>
                        <option value="5">5 Eixos (Carreta Simples)</option>
                        <option value="6">6 Eixos (Carreta LS)</option>
                        <option value="7">7 Eixos (Bitrem)</option>
                        <option value="9">9 Eixos (Rodotrem)</option>
                        <option value="11">11 Eixos (Super-Rodotrem)</option>
                    </select>
                </div>
                <div><label class="label-custo">Consumo M√©dio (Km/L)</label><input type="number" id="f-consumo" step="0.1" placeholder="Ex: 2.5"></div>
            </div>

            <div class="grid-configs">
                <div><label class="label-custo">Manuten√ß√£o (R$/Km)</label><input type="text" id="f-manut" placeholder="R$ 0,00" oninput="formatarMoeda(this)"></div>
                <div><label class="label-custo">Arla 32 (% do diesel)</label><input type="number" id="f-arla" placeholder="Ex: 5" step="0.1"></div>
            </div>

            <div class="f-checkbox">
                <input type="checkbox" id="f-tem-frio" onchange="document.getElementById('f-box-frio').style.display = this.checked ? 'block' : 'none'">
                <label for="f-tem-frio">Possui aparelho frio</label>
            </div>

            <div id="f-box-frio" style="display:none; margin-top: 10px;">
                <label class="label-custo">Consumo Aparelho Frio (L/Hora)</label>
                <input type="number" id="f-consumo-frio" placeholder="Ex: 2.0" step="0.1">
            </div>

            <button class="calc-btn" onclick="salvarVeiculo()">Salvar Ve√≠culo</button>
        </div>
        <div class="lista-frota-content" id="lista-v-render"></div>
    </div>

    <div class="sidebar">
        <div class="header-sidebar">
            <h2>Roteirizador</h2>
            <button style="background:none; border:none; color:red; cursor:pointer; font-size:10px;" onclick="window.location.reload()">Novo Frete</button>
            <button class="theme-toggle" id="themeBtn" style="display:none;">üåô</button>
        </div>

        <ul id="lista-pontos">
            <li class="ponto-item item-saida" id="li-saida">
                <span class="handle" style="cursor:default">üìç</span>
                <input id="saida" type="text" placeholder="Sa√≠da Deslocamento Vazio (Opcional)" autocomplete="off">
            </li>
            <div id="container-config-deslocamento" class="deslocamento-config">
                <label style="font-size:10px; font-weight:700; color:var(--text-sub); margin-bottom:2px;">DESLOCAMENTO REMUNERADO</label>
                <select id="tipoDeslocamento">
                    <option value="nao_remunerado">N√£o Remunerado</option>
                    <option value="remunerado_km">Remunerado R$ por KM vazio</option>
                    <option value="remunerado_rs">Remunerado R$ Fechado Deslocamento</option>
                </select>
                <input id="valorDeslocamentoKm" type="text" placeholder="R$ 0,00 por KM" style="display:none;">
                <input id="valorDeslocamentoTotal" type="text" placeholder="R$ 0,00 Total" style="display:none;">
            </div>
            <li class="ponto-item sortable-item" id="li-origem">
                <span class="handle">‚ò∞</span>
                <input id="origem" type="text" placeholder="Origem" autocomplete="off">
            </li>
            <li class="ponto-item sortable-item" id="li-destino">
                <span class="handle">‚ò∞</span>
                <input id="destino" type="text" placeholder="Destino" autocomplete="off">
            </li>
        </ul>

        <button class="btn-add" id="btnAddParada" style="width:100%; margin:8px 0; padding:8px; cursor:pointer; background:none; border:1px dashed var(--border-color); border-radius:4px; font-size:12px; color:var(--text-main);">+ Adicionar Parada</button>

        <div class="grid-configs">
            <div>
                <label style="font-size:10px; font-weight:700; color:var(--text-sub)">VALOR POR KM</label>
                <input id="valorPorKm" type="text" value="R$ 0,00" oninput="formatarMoeda(this)">
            </div>
            <div>
                <label style="font-size:10px; font-weight:700; color:var(--text-sub)">AL√çQUOTA IMPOSTO</label>
                <select id="imposto">
                      <option value="1">Isento (0%)</option>
                      <option value="0.93">7%</option>
                      <option value="0.88">12%</option>
                      <option value="0.83">17%</option>
                      <option value="0.825">17,5%</option>
                      <option value="0.82">18%</option>
                      <option value="0.81">19%</option>
                      <option value="0.80">20%</option>
                      <option value="0.795">20,5%</option>
                      <option value="0.79">21%</option>
                      <option value="0.78">22%</option>
                      <option value="0.77">23%</option>
                </select>
            </div>
        </div>

        <button class="calc-btn" id="btnCalcular">Calcular Rota</button>
        <button class="btn-gestao" onclick="toggleCustos()">Painel de Custos (Extra)</button>

        <div class="financeiro">
            <div class="row">KM Deslocado (Vazio) <span><b id="txt-km-vazio-det">0,0 km</b></span></div>
            <div class="row">KM Frete (Carregado) <span><b id="txt-km-rota-det">0,0 km</b></span></div>
            <div class="row" style="color:var(--text-main); font-weight:600; border-top: 1px solid var(--border-color); padding-top: 4px; margin-top: 4px;">KM Total <b id="txt-km-total">0,0 km</b></div>
            <div class="row" style="color:#2563eb; font-weight:700; margin-top:2px;">R$/Km Real <b id="txt-km-real">R$ 0,00</b></div>

            <div class="container-barra" style="margin-top:10px;">
                <div id="visual-vazio" class="barra-vazio" style="width: 0%;"></div>
                <div id="visual-rota" class="barra-rota" style="width: 100%;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; font-weight: 700; margin-bottom:10px;">
                <span style="color:#fb923c">Vazio: <span id="perc-vazio">0%</span></span>
                <span style="color:#60a5fa">Rota: <span id="perc-rota">100%</span></span>
            </div>

            <div class="row">Frete Base <span><b id="txt-frete-base">R$ 0,00</b></span></div>
            <div class="row">Deslocamento <span><b id="txt-valor-deslocamento-fin">R$ 0,00</b></span></div>
            <div class="row">Imposto <span><b id="txt-valor-imp" style="color:#ef4444">R$ 0,00</b></span></div>
            <div class="frete-destaque">
                <span style="font-size:10px; color:var(--text-sub); display:block;">TOTAL L√çQUIDO</span>
                <span id="txt-frete-total">R$ 0,00</span>
            </div>
        </div>
    </div>

    <div id="painel-custos-extra">
        <div class="header-sidebar">
            <h2>Custos Adicionais</h2>
            <button style="background:none; border:none; color:red; cursor:pointer; font-size:10px;" onclick="limparPainelCustos()">Limpar</button>
        </div>
        
        <div class="secao-custo">
            <label class="label-custo">Ve√≠culo da Frota</label>
            <select id="selFrotaVinculo" onchange="vincularFrota(this)">
            </select>
        </div>

        <div class="secao-custo">
            <label class="label-custo">Diesel</label>
            <div class="grid-configs" style="margin-top:0;">
                <div><span class="sub-label">PRE√áO/L</span><input type="text" id="custoDieselLitro" placeholder="R$ 0,00" oninput="formatarMoeda(this)"></div>
                <div><span class="sub-label">M√âDIA KM/L</span><input type="number" id="consumoDieselMedia" placeholder="Ex: 2.5" step="0.1" oninput="atualizarFinanceiro()"></div>
            </div>
        </div>

        <div class="secao-custo">
            <label class="label-custo">Arla 32</label>
            <div class="grid-configs" style="margin-top:0;">
                <div><span class="sub-label">PRE√áO/L</span><input type="text" id="custoArlaLitro" placeholder="R$ 0,00" oninput="formatarMoeda(this)"></div>
                <div><span class="sub-label">% DO DIESEL</span><input type="number" id="arlaPorcentagem" placeholder="Ex: 5" step="0.1" oninput="atualizarFinanceiro()"></div>
            </div>
        </div>

        <div class="secao-custo">
            <div class="grid-configs" style="margin-top:0;">
                <div>
                    <label class="label-custo">Ped√°gios</label>
                    <input type="text" id="custoPedagio" placeholder="Valor Total R$" oninput="formatarMoeda(this)">
                </div>
                <div>
                    <label class="label-custo">Manuten√ß√£o (por KM)</label>
                    <input type="text" id="custoManutencaoKm" placeholder="R$ 0,00 por KM" oninput="formatarMoeda(this)">
                </div>
            </div>
        </div>

        <div class="secao-custo">
            <div class="grid-configs" style="margin-top:0; grid-template-columns: 1.5fr 1fr;">
                <div>
                    <label class="label-custo">Tipo de Carga</label>
                    <select id="tipoCarga" onchange="toggleAparelhoFrio()">
                        <option value="seca">Carga Seca</option>
                        <option value="frigorifica">Carga Frigor√≠fica</option>
                        <option value="granel">Carga a Granel</option>
                        <option value="sider">Carga Sider</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div id="container-frio-input" style="display:none;">
                    <label class="label-custo">Consumo Frio L/H</label>
                    <input type="number" id="consumoFrioHora" placeholder="Ex: 2.5" step="0.1" oninput="atualizarFinanceiro()">
                </div>
            </div>
        </div>

        <div id="container-frio-datas" style="display:none;">
            <div id="alerta-datas-frio" class="alerta-erro">‚ö†Ô∏è Informar Coleta e Entrega para C√°lculo do Aparelho Frio</div>
            <div id="alerta-erro-datas" class="alerta-erro">‚ö†Ô∏è Previs√£o Entrega n√£o pode ser anterior a Previs√£o Coleta</div>
            
            <div class="secao-custo">
                <div class="grid-configs">
                    <div>
                        <label class="label-custo">Previs√£o Coleta</label>
                        <input type="datetime-local" id="prevColeta" onchange="atualizarFinanceiro()">
                    </div>
                    <div>
                        <label class="label-custo">Previs√£o Entrega</label>
                        <input type="datetime-local" id="prevEntrega" onchange="atualizarFinanceiro()">
                    </div>
                </div>
            </div>
        </div>

        <div class="financeiro" style="background: #eff6ff; border-color: #bfdbfe;">
            <div class="row" style="color: #1e40af; font-weight: 700;">RESULTADO OPERACIONAL</div>
            
            <div id="analise-custos-detalhada" style="margin: 10px 0; border-bottom: 1px solid #bfdbfe; padding-bottom: 5px;">
                <div class="row">Custo Diesel <span id="txt-an-diesel">R$ 0,00</span></div>
                <div class="row">Custo Arla <span id="txt-an-arla">R$ 0,00</span></div>
                <div class="row">Custo Ped√°gio <span id="txt-an-pedagio">R$ 0,00</span></div>
                <div class="row">Custo Manut. <span id="txt-an-manut">R$ 0,00</span></div>
                <div class="row" id="row-an-frio" style="display:none;">Custo Ap. Frio <span id="txt-an-frio">R$ 0,00</span></div>
            </div>

            <div class="row" style="font-weight: 600; margin-top: 10px;">Frete <span id="txt-an-frete-liquido">R$ 0,00</span></div>
            
            <div class="row" style="font-weight: 600;">Imposto <span id="txt-an-imposto">R$ 0,00</span></div>

            <div class="row" style="font-weight: 600;">Total Custos <span id="txt-total-custos">R$ 0,00</span></div>
            
            <div class="frete-destaque" style="color: #16a34a; border-top-color: #bfdbfe;" id="destaque-lucro">
                <span style="font-size:10px; color:var(--text-sub); display:block;">LUCRO ESTIMADO</span>
                <span id="txt-lucro-real">R$ 0,00</span>
            </div>
        </div>
    </div>

    <div class="map-container"><div id="map"></div></div>
</div>

<script>
    let map, directionsRenderer, directionsService, paradasData = {}, rotaIniciada = false;
    let distVazioMetros = 0, distRotaMetros = 0;
    let frota = JSON.parse(localStorage.getItem('frota_db')) || [];

    const darkStyle = [{ "elementType": "geometry", "stylers": [{ "color": "#242f3e" }] }, { "elementType": "labels.text.fill", "stylers": [{ "color": "#746855" }] }, { "elementType": "labels.text.stroke", "stylers": [{ "color": "#242f3e" }] }, { "featureType": "road", "elementType": "geometry", "stylers": [{ "color": "#38414e" }] }, { "featureType": "water", "elementType": "geometry", "stylers": [{ "color": "#17263c" }] }];

    function toggleFrota() { 
        const painel = document.getElementById('painel-frota');
        painel.classList.toggle('active');
        renderFrota();
    }

    function salvarVeiculo() {
        const idx = parseInt(document.getElementById('f-edit-index').value);
        const v = {
            nome: document.getElementById('f-nome').value,
            eixos: document.getElementById('f-eixos').value,
            consumo: document.getElementById('f-consumo').value,
            manut: document.getElementById('f-manut').value,
            arla: document.getElementById('f-arla').value,
            temFrio: document.getElementById('f-tem-frio').checked,
            consumoFrio: document.getElementById('f-consumo-frio').value
        };
        if(!v.nome) return alert("Apelido/Modelo obrigat√≥rio");
        if(idx === -1) frota.push(v); else frota[idx] = v;
        localStorage.setItem('frota_db', JSON.stringify(frota));
        document.getElementById('f-nome').value = ''; 
        document.getElementById('f-consumo').value = '';
        document.getElementById('f-manut').value = '';
        document.getElementById('f-arla').value = '';
        document.getElementById('f-tem-frio').checked = false;
        document.getElementById('f-box-frio').style.display = 'none';
        document.getElementById('f-edit-index').value = '-1';
        document.getElementById('frota-titulo').innerText = "Minha Frota";
        renderFrota();
        updateSelects();
    }

    function renderFrota() {
        const container = document.getElementById('lista-v-render');
        container.innerHTML = frota.map((v, i) => `
            <div class="veiculo-card">
                <div><b>${v.nome}</b><br><small>${v.eixos} Eixos | ${v.consumo} Km/L</small></div>
                <div>
                    <button onclick="editV(${i})" style="border:none; background:none; cursor:pointer;">‚úèÔ∏è</button>
                    <button onclick="delV(${i})" style="border:none; background:none; cursor:pointer; color:red;">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }

    function editV(i) {
        const v = frota[i];
        document.getElementById('f-nome').value = v.nome;
        document.getElementById('f-eixos').value = v.eixos;
        document.getElementById('f-consumo').value = v.consumo;
        document.getElementById('f-manut').value = v.manut;
        document.getElementById('f-arla').value = v.arla || '';
        document.getElementById('f-tem-frio').checked = v.temFrio || false;
        document.getElementById('f-box-frio').style.display = v.temFrio ? 'block' : 'none';
        document.getElementById('f-consumo-frio').value = v.consumoFrio || '';
        document.getElementById('f-edit-index').value = i;
        document.getElementById('frota-titulo').innerText = "Editar Ve√≠culo";
    }

    function delV(i) {
        frota.splice(i, 1);
        localStorage.setItem('frota_db', JSON.stringify(frota));
        renderFrota();
        updateSelects();
    }

    function updateSelects() {
        const sel = document.getElementById('selFrotaVinculo');
        if(!sel) return;
        let html = '<option value="">Selecione...</option>';
        html += '<option value="manual">Inserir Manualmente</option>';
        frota.forEach((v, i) => { html += `<option value="${i}">${v.nome}</option>`; });
        sel.innerHTML = html;
    }

    function vincularFrota(sel) {
        const inputsCustos = ["consumoDieselMedia", "custoManutencaoKm", "consumoFrioHora", "arlaPorcentagem"];
        if(sel.value === "manual" || sel.value === "") {
            inputsCustos.forEach(id => { const el = document.getElementById(id); if(el) { el.readOnly = false; el.style.opacity = "1"; } });
            return;
        }
        const v = frota[sel.value];
        document.getElementById('consumoDieselMedia').value = v.consumo;
        document.getElementById('custoManutencaoKm').value = v.manut;
        document.getElementById('arlaPorcentagem').value = v.arla;
        document.getElementById('consumoFrioHora').value = v.consumoFrio || "";
        inputsCustos.forEach(id => { const el = document.getElementById(id); if(el) { el.readOnly = true; el.style.opacity = "0.8"; } });
        atualizarFinanceiro();
    }

    function toggleAparelhoFrio() {
        const isFrigo = document.getElementById("tipoCarga").value === "frigorifica";
        document.getElementById("container-frio-input").style.display = isFrigo ? "block" : "none";
        document.getElementById("container-frio-datas").style.display = isFrigo ? "block" : "none";
        atualizarFinanceiro();
    }

    function toggleCustos() {
        const painel = document.getElementById('painel-custos-extra');
        const isHidden = window.getComputedStyle(painel).display === 'none';
        const novoEstado = isHidden ? 'block' : 'none';
        painel.style.display = novoEstado;
        localStorage.setItem('painelCustosEstado', novoEstado);
        if (map) {
            setTimeout(() => { google.maps.event.trigger(map, "resize"); }, 300);
        }
    }

    function formatarMoeda(input) {
        let value = input.value.replace(/\D/g, "");
        value = (value / 100).toFixed(2) + "";
        value = value.replace(".", ",");
        value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        input.value = "R$ " + value;
        atualizarFinanceiro();
    }

    function converterParaFloat(stringMoeda) {
        if (!stringMoeda || typeof stringMoeda !== 'string') return 0;
        return parseFloat(stringMoeda.replace("R$ ", "").replace(/\./g, "").replace(",", ".")) || 0;
    }

    function initApp() {
        map = new google.maps.Map(document.getElementById("map"), { center: { lat: -14.235, lng: -51.925 }, zoom: 4, mapTypeControl: false });
        directionsRenderer = new google.maps.DirectionsRenderer({ draggable: true, map: map });
        directionsService = new google.maps.DirectionsService();
        
        Sortable.create(document.getElementById('lista-pontos'), { 
            animation: 150, handle: '.handle', draggable: '.sortable-item', 
            onEnd: () => { if(rotaIniciada) calcularRota(); } 
        });

        setupAutocomplete("saida"); setupAutocomplete("origem"); setupAutocomplete("destino");

        document.getElementById("themeBtn").onclick = function() {
            document.body.classList.toggle("dark-mode");
            map.setOptions({ styles: document.body.classList.contains("dark-mode") ? darkStyle : [] });
        };

        document.getElementById("tipoDeslocamento").onchange = function() {
            document.getElementById("valorDeslocamentoKm").style.display = (this.value === "remunerado_km") ? "block" : "none";
            document.getElementById("valorDeslocamentoTotal").style.display = (this.value === "remunerado_rs") ? "block" : "none";
            atualizarFinanceiro();
        };

        ["valorPorKm", "valorDeslocamentoKm", "valorDeslocamentoTotal", "custoDieselLitro", "custoPedagio", "custoManutencaoKm", "custoArlaLitro"].forEach(id => {
            const el = document.getElementById(id); 
            if(el) el.oninput = () => { 
                if(!["consumoDieselMedia", "arlaPorcentagem", "consumoFrioHora"].includes(id)) formatarMoeda(el); 
                atualizarFinanceiro(); 
            };
        });

        document.getElementById("imposto").onchange = atualizarFinanceiro;
        document.getElementById("btnAddParada").onclick = () => { adicionarCampoParada(); };
        document.getElementById("btnCalcular").onclick = () => { calcularRota(); };
        
        directionsRenderer.addListener('directions_changed', () => { 
            const res = directionsRenderer.getDirections(); if (res) processarSegmentosRota(res); 
        });

        updateSelects();

        const estadoSalvo = localStorage.getItem('painelCustosEstado');
        if (estadoSalvo) document.getElementById('painel-custos-extra').style.display = estadoSalvo;
    }

    function setupAutocomplete(id) {
        const input = document.getElementById(id);
        if(!input) return;
        const auto = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: "br" }, fields: ["place_id", "geometry"] });
        auto.addListener("place_changed", () => { 
            const place = auto.getPlace(); 
            if (!place.place_id) return;
            paradasData[id] = place.place_id; 
            if (id === "saida") document.getElementById("container-config-deslocamento").style.display = "flex";
            if(rotaIniciada) calcularRota(); 
        });
    }

    function adicionarCampoParada() {
        const id = `parada_${Date.now()}`;
        const li = document.createElement("li");
        li.className = "ponto-item sortable-item";
        li.innerHTML = `<span class="handle">‚ò∞</span><input id="${id}" type="text" placeholder="Parada" autocomplete="off"><button class="btn-remove" onclick="this.parentElement.remove()">‚úï</button>`;
        document.getElementById("lista-pontos").insertBefore(li, document.getElementById("li-destino"));
        setupAutocomplete(id);
        setTimeout(() => { document.getElementById(id).focus(); }, 100);
    }

    function calcularRota() {
        const ids = Array.from(document.querySelectorAll("#lista-pontos li input[type='text']")).map(i => paradasData[i.id]).filter(id => id);
        if (ids.length < 2) return;
        const request = { origin: { placeId: ids[0] }, destination: { placeId: ids[ids.length - 1] }, waypoints: ids.slice(1, -1).map(id => ({ location: { placeId: id }, stopover: true })), travelMode: google.maps.TravelMode.DRIVING };
        directionsService.route(request, (res, status) => { if (status === "OK") { directionsRenderer.setDirections(res); rotaIniciada = true; processarSegmentosRota(res); } });
    }

    function processarSegmentosRota(res) {
        const legs = res.routes[0].legs;
        const temSaida = document.getElementById("saida").value;
        if (temSaida && legs.length >= 2) {
            distVazioMetros = legs[0].distance.value;
            distRotaMetros = legs.slice(1).reduce((acc, leg) => acc + leg.distance.value, 0);
        } else {
            distVazioMetros = 0;
            distRotaMetros = legs.reduce((acc, leg) => acc + leg.distance.value, 0);
        }
        atualizarFinanceiro();
    }

    function atualizarFinanceiro() {
        const kmVazio = distVazioMetros / 1000; 
        const kmRota = distRotaMetros / 1000; 
        const kmTotal = kmVazio + kmRota;
        const vKmRota = converterParaFloat(document.getElementById("valorPorKm").value);
        const divisor = parseFloat(document.getElementById("imposto").value);
        const tipoDesl = document.getElementById("tipoDeslocamento").value;
        
        let freteBase = kmRota * vKmRota; 
        let valorDeslocamento = 0;
        if (tipoDesl === "remunerado_km") valorDeslocamento = kmVazio * converterParaFloat(document.getElementById("valorDeslocamentoKm").value);
        else if (tipoDesl === "remunerado_rs") valorDeslocamento = converterParaFloat(document.getElementById("valorDeslocamentoTotal").value);
        
        let baseCalculoParaImposto = freteBase + valorDeslocamento;
        const freteTotalComImposto = baseCalculoParaImposto / divisor;
        const valorDoImposto = freteTotalComImposto - baseCalculoParaImposto;

        const options = { minimumFractionDigits: 2, maximumFractionDigits: 2 };

        document.getElementById("txt-km-vazio-det").innerText = kmVazio.toFixed(1) + " km";
        document.getElementById("txt-km-rota-det").innerText = kmRota.toFixed(1) + " km";
        document.getElementById("txt-km-total").innerText = kmTotal.toFixed(1) + " km";
        document.getElementById("txt-frete-base").innerText = "R$ " + freteBase.toLocaleString('pt-BR', options);
        document.getElementById("txt-valor-deslocamento-fin").innerText = "R$ " + valorDeslocamento.toLocaleString('pt-BR', options);
        document.getElementById("txt-valor-imp").innerText = "R$ " + valorDoImposto.toLocaleString('pt-BR', options);
        document.getElementById("txt-frete-total").innerText = "R$ " + freteTotalComImposto.toLocaleString('pt-BR', options);

        document.getElementById("txt-an-frete-liquido").innerText = "R$ " + freteTotalComImposto.toLocaleString('pt-BR', options);
        document.getElementById("txt-an-imposto").innerText = "R$ " + valorDoImposto.toLocaleString('pt-BR', options);

        const precoDiesel = converterParaFloat(document.getElementById("custoDieselLitro").value);
        const consumoDiesel = parseFloat(document.getElementById("consumoDieselMedia").value) || 0;
        const precoArla = converterParaFloat(document.getElementById("custoArlaLitro").value);
        const arlaPerc = (parseFloat(document.getElementById("arlaPorcentagem").value) || 0) / 100;
        const pedagio = converterParaFloat(document.getElementById("custoPedagio").value);
        const manutKm = converterParaFloat(document.getElementById("custoManutencaoKm").value);

        const custoDieselTotal = (consumoDiesel > 0) ? (kmTotal / consumoDiesel) * precoDiesel : 0;
        const custoArlaTotal = (consumoDiesel > 0) ? ((kmTotal / consumoDiesel) * arlaPerc) * precoArla : 0;
        const custoManutTotal = kmTotal * manutKm;

        let custoFrioTotal = 0;
        if (document.getElementById("tipoCarga").value === "frigorifica") {
            const consFrio = parseFloat(document.getElementById("consumoFrioHora").value) || 0;
            const pColetaStr = document.getElementById("prevColeta").value;
            const pEntregaStr = document.getElementById("prevEntrega").value;
            const pColeta = new Date(pColetaStr);
            const pEntrega = new Date(pEntregaStr);

            const alertDatasFrio = document.getElementById("alerta-datas-frio");
            const alertErroDatas = document.getElementById("alerta-erro-datas");

            if (!pColetaStr || !pEntregaStr) {
                alertDatasFrio.style.display = "block";
                alertErroDatas.style.display = "none";
            } else if (pEntrega <= pColeta) {
                alertDatasFrio.style.display = "none";
                alertErroDatas.style.display = "block";
            } else {
                alertDatasFrio.style.display = "none";
                alertErroDatas.style.display = "none";
                const horas = Math.abs(pEntrega - pColeta) / 36e5;
                custoFrioTotal = horas * consFrio * precoDiesel;
                document.getElementById("row-an-frio").style.display = "flex";
                document.getElementById("txt-an-frio").innerText = "R$ " + custoFrioTotal.toLocaleString('pt-BR', options);
            }
        } else {
            document.getElementById("row-an-frio").style.display = "none";
        }

        const totalCustos = custoDieselTotal + custoArlaTotal + pedagio + custoManutTotal + custoFrioTotal;
        const lucroReal = freteTotalComImposto - totalCustos - valorDoImposto;

        document.getElementById("txt-an-diesel").innerText = "R$ " + custoDieselTotal.toLocaleString('pt-BR', options);
        document.getElementById("txt-an-arla").innerText = "R$ " + custoArlaTotal.toLocaleString('pt-BR', options);
        document.getElementById("txt-an-pedagio").innerText = "R$ " + pedagio.toLocaleString('pt-BR', options);
        document.getElementById("txt-an-manut").innerText = "R$ " + custoManutTotal.toLocaleString('pt-BR', options);
        document.getElementById("txt-total-custos").innerText = "R$ " + totalCustos.toLocaleString('pt-BR', options);
        document.getElementById("txt-lucro-real").innerText = "R$ " + lucroReal.toLocaleString('pt-BR', options);

        const txtLucro = document.getElementById("txt-lucro-real");
        if (lucroReal < 0) {
            txtLucro.style.color = "#ef4444";
        } else {
            txtLucro.style.color = "#16a34a";
        }

        const pVazio = kmTotal > 0 ? (kmVazio / kmTotal * 100) : 0;
        document.getElementById("visual-vazio").style.width = pVazio + "%";
        document.getElementById("perc-vazio").innerText = pVazio.toFixed(1) + "%";
        document.getElementById("perc-rota").innerText = (100 - pVazio).toFixed(1) + "%";
        const rKmReal = kmTotal > 0 ? ((freteBase + valorDeslocamento) / kmTotal) : 0;
        document.getElementById("txt-km-real").innerText = "R$ " + rKmReal.toLocaleString('pt-BR', options);
    }

    function limparPainelCustos() {
        ["custoDieselLitro", "consumoDieselMedia", "custoArlaLitro", "arlaPorcentagem", "custoPedagio", "custoManutencaoKm", "consumoFrioHora", "prevColeta", "prevEntrega"].forEach(id => {
            const el = document.getElementById(id); if(el) el.value = "";
        });
        document.getElementById("selFrotaVinculo").value = "";
        document.getElementById("tipoCarga").value = "seca";
        toggleAparelhoFrio();
    }

    window.onload = () => {
        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyClbY5ZvkjrMGP4nJmZzCcm4hUu5-fjZV0&libraries=places&callback=initApp`;
        script.async = true;
        document.head.appendChild(script);
    };
</script>
</body>
</html>
